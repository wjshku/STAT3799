"0",""
"0","Bias_nw <- function(para, train_label, test_x, width, muk){"
"0","  pesti <- phat(para$n, para$h, test_x ,train_label$X, k)"
"0","  p1esti <- p_1_esti(para, train_label, test_x, width)"
"0","  mx1esti <- mx_1_esti(para, train_label, test_x, width)"
"0","  mx2esti <- mx_2_esti(para, train_label, test_x, width)"
"0","  bias <- para$h^2 * mx1esti  * p1esti * muk$value / pesti + para$h^2 * mx2esti * muk$value / 2"
"0","  return(bias)"
"0","}"
"0",""
"0","Var_nw <- function(para, train_label, test_x, width, rk, sigmaep_esti){"
"0","  pesti <- phat(para$n, para$h, test_x ,train_label$X, k)"
"0","  return(sigmaep_esti^2*rk$value/(para$n*para$h*pesti))"
"0","}"
"0",""
"0","CI_nw <- function(level,mx_deriv1,para,train_label,test,sigmaep_esti,px,rk,muk){"
"0","  var_esti <- Var_nw(para, train_label, test$X, width, rk, sigmaep_esti)"
"0","  bias_esti <- Bias_nw(para, train_label, test$X, width, muk)"
"0","  "
"0","  nw_esti <- mhat(para$n, para$h, test$X, train_label$X, train_label$Y, k)"
"0","  upper <- nw_esti - bias_esti + sqrt(var_esti)*qnorm(1-(1 - level)/2)"
"0","  lower <- nw_esti - bias_esti - sqrt(var_esti)*qnorm(1-(1 - level)/2)"
"0","}"
"0","nw_ci <- function(rounds,para, test, hlist){"
"0",""
"0","    coverage_nw_byhg <- data.frame()"
"0","    "
"0","    for(h in hlist){"
"0","        coverage_nw <- data.frame()"
"0","        for(i in 1:rounds){"
"0","          data <- simu_norm(para$m + para$n, 1, meanx = 0, sigmax = sigmax, sigmaep = sigmaep)"
"0","          train_label <- data[1:para$n,]"
"0","          train_un <- data[(1+para$n):(para$n+para$m),]"
"0",""
"0","          h_opt <- (8*pi^(1/2)/3)^(1/5)*sd(data$X)*(rk$value/muk$value^2/para$n)^(1/5)"
"0","          px <- phat(para$n,h_opt,test$X,data$X,k)"
"0",""
"0","          h_opt <- nw_cv(hlist = seq(0.1,4,0.1),train_label)"
"0","          sigmaep_esti <- esti_sigmaep(para$n,h_opt,train_label)"
"0","          mx_deriv1 <- mhat_1(para$n,h_opt,test$X,train_label$X,train_label$Y,k,k_1)"
"0","  "
"0","          para$h <- h"
"0","  "
"0","          coverage_nw <- rbind(coverage_nw,CI_nw(0.95,mx_deriv1,para,train_label,test,sigmaep_esti,px,rk,muk))"
"0","        }"
"0","        "
"0","        coverage_nw$cover <- (coverage_nw$lower <= test$Y)*(coverage_nw$upper >= test$Y)"
"0","        "
"0","        coverage_nw_byhg <- rbind(coverage_nw_byhg,data.frame(h = h,length = mean(coverage_nw$upper - coverage_nw$lower), coverage = mean(coverage_nw$cover,na.rm = T)))"
"0","    }"
"0","    coverage_nw_byhg$Error <- abs(coverage_nw_byhg$coverage - 0.95)"
"0","  return(coverage_nw_byhg)"
"0","}"
